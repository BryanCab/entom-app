
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Constancia de Servicio ‚Äî Fumigaciones ENTOM</title>
<style>
:root{
 --bg:#fff; --text:#1b1f2a; --muted:#667085; --surface:#f7f8fa;
 --border:#cfd5df; --primary:#1459ff; --danger:#d84d57;
 --radius:10px; --radius-sm:8px;
 --font:system-ui,-apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
 --page-width:216mm; --page-height:279mm; /* Carta */
}
html.dark{
 --bg:#0f1115; --text:#f4f7fb; --muted:#c0c7d1;
 --surface:#1a1f2c; --border:#2b3242; --primary:#5b9cff; --danger:#ff8088;
}
/* ==== Vista formulario ==== */
*{ box-sizing:border-box; }
html, body{ height:100%; }
body{ margin:0; font-family:var(--font); color:var(--text); background:#eef1f6; }
.page{
 max-width:1100px; margin:24px auto; padding:20px; background:var(--bg);
 border:1px solid var(--border); border-radius:var(--radius);
 box-shadow:0 10px 30px rgba(0,0,0,.08);
}
.page__header,.page__footer{
 display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
}
.brand{ display:flex; align-items:center; gap:12px; }
.title{ margin:0; }
.subtitle{ margin:2px 0 0; color:var(--muted); font-size:.95rem; }
.actions{ display:flex; gap:8px; }
.btn{
 border:1px solid var(--border); background:var(--surface); color:var(--text);
 padding:9px 13px; border-radius:var(--radius-sm); cursor:pointer; transition:.2s;
}
.btn:hover{ transform:translateY(-1px); }
.btn--primary{ background:var(--primary); color:#fff; border-color:transparent; }
.btn--danger{ background:#ffe9eb; color:#b02a37; border-color:#ffd0d4; }
/* ===== LOGO header ===== */
.brand__logo{
 width:56px; height:56px; display:block; border-radius:10px;
 border:1px solid var(--border);
 box-shadow:0 4px 10px rgba(0,0,0,.06);
 background: url('logo.png') center/contain no-repeat, linear-gradient(135deg, var(--primary), #9ec1ff);
 color:transparent; overflow:hidden; text-indent:-9999px; user-select:none;
}
html.dark .brand__logo{ border-color:#2b3242; }
/* ====== Secciones / campos ====== */
.section{ margin-top:16px; padding:12px; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg); }
.section__title{ margin:0 0 10px 0; font-size:1.05rem; }
.grid{ display:grid; gap:10px; }
.grid--2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
.grid--3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
.grid--4{ grid-template-columns: repeat(4, minmax(0,1fr)); }
.field{ display:flex; flex-direction:column; gap:6px; }
.field--span2{ grid-column: span 2; }
label{ font-size:.94rem; }
input[type="text"], input[type="date"], input[type="tel"], input[type="number"], input[type="time"], textarea{
 width:100%; border:1px solid var(--border); border-radius:10px; background:var(--surface); color:var(--text);
 padding:9px 11px; outline:none; transition:.15s;
}
textarea{ resize:vertical; min-height:40px; }
input:focus, textarea:focus{
 border-color:var(--primary);
 box-shadow:0 0 0 3px color-mix(in srgb, var(--primary) 25%, transparent);
}
.inline{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.option{ display:flex; align-items:center; gap:8px; padding:4px 0; }
.folio{ font-weight:800; text-align:center; color:#c43b3b; background:var(--surface); }
/* Tabla (captura) */
.table{ border:1px solid var(--border); border-radius:10px; overflow:hidden; }
.table__head,.table__row{ display:grid; grid-template-columns:1.1fr .5fr .5fr .8fr .6fr 1.1fr .6fr; gap:8px; }
.table__head{ background:#e9eef7; color:#1f2a3a; font-weight:600; padding:9px 12px; }
.table__body .table__row{ padding:8px 12px; border-top:1px solid var(--border); align-items:center; }
.table input, .table select{ background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:6px 8px; }
/* Firmas (captura) */
.signature{ border:1px dashed var(--border); border-radius:10px; padding:10px; }
.sig-pad{ position:relative; border-radius:8px; border:1px solid var(--border); background:repeating-linear-gradient(0deg,#f6f8fb,#f6f8fb 22px,#edf2fa 23px); }
html.dark .sig-pad{ background:repeating-linear-gradient(0deg,#101623,#101623 22px,#0c1323 23px); }
.sig-pad::after{ content:"Firme aqu√≠"; position:absolute; top:8px; right:12px; color:var(--muted); font-size:.9rem; pointer-events:none; }
canvas[data-sig]{ display:block; width:100%; height:auto; }
/* Info fija (formulario) con look input */
.info-fixed{
 font-size:.95rem; color:#222; line-height:1.25;
 background:#ecf2ff; border:1px solid var(--border);
 border-radius:10px; padding:9px 11px; margin-top:6px;
}
/* ======= Hoja de impresi√≥n ======= */
#printSheet{
 display:none; width: var(--page-width); height: var(--page-height); margin:0 auto; background:#fff; color:#000;
 font-size: 9.5pt; line-height: 1.12;
 border: 1px solid transparent; position: relative; padding: 6.5mm 7mm;
}
/* >>> Marca de agua (√∫nico ajuste) <<< */
#wm{
 position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:0;
 opacity:.20;                               /* muy tenue */
 background: url('logo.png') center/70% no-repeat; /* logo en el centro, grande pero sin invadir */
 filter: grayscale(100%) blur(0.4px);       /* desaturado y ligeramente difuminado */
}
#printSheet > *:not(#wm){ position:relative; z-index:1; }
/* Estructura PDF */
.ps-box{ border:1px solid #444; padding:2mm; margin-bottom:2mm; }
.ps-small{ font-size:8.9pt; }
.ps-header{ display:grid; grid-template-columns: 1fr auto auto; gap:2mm; align-items:center; }
.ps-title{ font-weight:800; font-size:12.4pt; }
.ps-sub{ color:#333; }
.ps-tag{ display:inline-block; border:1px solid #444; padding:.25mm .8mm; border-radius:3px; margin:0 1.2mm 1.2mm 0; }
.ps-tag--on{ background:#111; color:#fff; border-color:#111; }
/* Pares ETIQUETA ‚Üí VALOR (compactos) */
.ps-vl-grid{ display:grid; grid-template-columns: repeat(12,1fr); gap:.8mm; }
.ps-vl{ border-bottom:1px solid #444; padding:.4mm .6mm; display:flex; align-items:center; gap:2mm; }
.ps-vl .lbl{ color:#000; opacity:.9; font-weight:600; }
.ps-vl .val{ min-width:8mm; }
/* Celdas con l√≠nea (para listas) */
.ps-cell{ border-bottom:1px solid #444; padding:.5mm .7mm; min-height:4mm; }
/* Tabla PDF productos */
.ps-table{ width:100%; border-collapse:collapse; border:1px solid #444; }
.ps-table th, .ps-table td{ border:1px solid #444; padding:1mm; font-size:9pt; }
.ps-table th{ background:#f2f2f2; }
/* Mezcla e Informaci√≥n (PDF) */
.ps-mi-grid{ display:grid; grid-template-columns: repeat(6, 1fr); gap: 2mm; align-items:end; }
.ps-mi-head{ font-weight:600; }
.ps-uline{ display:inline-block; min-width: 14mm; border-bottom:1px solid #444; line-height:1.1; padding:0 .6mm .4mm .6mm; }
.ps-info-row{ display:grid; grid-template-columns: auto 1fr; gap:2mm; align-items:center; }
.ps-info-title{ font-weight:600; }
.ps-info-text{ border:1px solid #444; background:#fff; padding:1mm 1.2mm; line-height:1.15; text-align:left; }
/* M√©tricas compactas */
.ps-metrics-wrap{ margin-top:1.4mm; }
.ps-metrics-title{ font-weight:600; margin-bottom:1mm; }
.ps-metrics{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:2mm; align-items:stretch; }
.ps-mchip{ border:1px solid #444; background:#fbfbfb; padding:.6mm .9mm; min-width:15mm; display:flex; flex-direction:column; justify-content:center; align-items:center; }
.ps-mchip__label{ font-weight:700; font-size:8pt; line-height:1; }
.ps-mchip__val{ font-weight:800; font-size:9pt; line-height:1.15; }
/* Firmas */
.ps-signs{ display:grid; grid-template-columns: 1fr 1fr; gap:2.6mm; }
.ps-sign{ border:1px solid #444; height:14mm; display:flex; align-items:center; justify-content:center; position:relative; }
.ps-sign img{ max-width:95%; max-height:95%; object-fit:contain; }
.ps-signname{ text-align:center; font-size:9pt; margin-top:1mm; border-top:1px solid #444; padding-top:.8mm; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
/* Impresi√≥n */
@media print{
 @page { size: letter; margin: 6mm; }
 html{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
 body{ background:#fff !important; }
 .actions, .subtitle, .signature__actions{ display:none !important; }
 .page{ padding:0; border:none; box-shadow:none; }
 #formDoc{ display:none !important; }
 #printSheet{ display:block !important; }
 .brand__logo{ display:none !important; }
}
/* Responsivo */
@media (max-width:820px){
 .grid--4{ grid-template-columns: repeat(2, minmax(0,1fr)); }
 .grid--3{ grid-template-columns: 1fr; }
 .grid--2{ grid-template-columns: 1fr; }
 .table__head, .table__row{ grid-template-columns:1fr .5fr .5fr .8fr .6fr 1.1fr .6fr; }
}
@media print{
 .page__header{ display:none !important; }
}


/* =========================
   MODO TARJETAS EN M√ìVIL
   ========================= */
@media (max-width: 820px) {

  /* Oculta encabezados de la tabla */
  .table__head {
    display: none !important;
  }

  /* Las filas se vuelven tarjetas */
  .table__body .table__row {
    display: block !important;
    background: var(--bg);
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    margin-bottom: 14px;
  }

  /* Cada campo ocupa ancho completo */
  .table__body .table__row > * {
    display: block !important;
    width: 100% !important;
    margin: 10px 0 !important;
  }

  /* Etiqueta generada por JS */
  .mpr-label {
    font-size: .9rem;
    font-weight: 600;
    color: var(--muted);
    margin-bottom: 4px;
  }

  /* Inputs c√≥modos en m√≥vil y sin zoom iOS */
  .table__body input,
  .table__body select {
    width: 100% !important;
    padding: 10px 14px !important;
    font-size: 16px !important; /* evita zoom iOS */
  }

  /* Caja de acciones */
  .mpr__actions {
    display: flex !important;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 12px;
  }
}


</style>


<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registrado"))
    .catch(err => console.error("Error al registrar SW:", err));
}
</script>




</head>
<body>
<main class="page">
  <header class="page__header">
    <div class="brand">
      <div class="brand__logo" aria-label="Logo">FE</div>
      <div class="brand__text">
        <h1 class="title">Fumigaciones ENTOM</h1>
        <p class="subtitle">Constancia de Servicio</p>
      </div>
    </div>
    <div class="actions">
      <button id="btnTheme" class="btn" type="button">üåû Tema</button>
      <button id="btnPrint" class="btn btn--primary" type="button">üñ®Ô∏è Imprimir / PDF</button>
      <button id="btnClear" class="btn btn--danger" type="button">üßΩ Limpiar</button>
    </div>
  </header>

  <!-- ===== Formulario (captura) ===== -->
  <form id="formDoc" novalidate>
    <!-- Encabezado -->
    <section class="section">
      <div class="grid grid--3">
        <div class="field">
          <label for="folio">Constancia de Servicio No.</label>
          <input id="folio" name="folio" class="folio" type="text" placeholder="(escribe tu folio)" maxlength="15" />
        </div>
        <div class="field">
          <label for="fecha">Fecha</label>
          <input id="fecha" name="fecha" type="date" required />
        </div>
        <div class="field">
          <label for="tecnico">T√©cnico responsable</label>
          <input id="tecnico" name="tecnico" type="text" placeholder="Nombre del t√©cnico" required />
        </div>
      </div>
    </section>

    <!-- Cliente -->
    <section class="section">
      <h2 class="section__title">Cliente</h2>
      <div class="grid grid--4">
        <div class="field field--span2">
          <label for="cliente">Cliente</label>
          <input id="cliente" name="cliente" type="text" required />
        </div>
        <div class="field">
          <label for="nic">N.I.C.</label>
          <input id="nic" name="nic" type="text" maxlength="15" />
        </div>
        <div class="field">
          <label for="tel">Tel√©fono</label>
          <input id="tel" name="tel" type="tel" placeholder="(33) 1234 5678" />
        </div>
        <div class="field">
          <label for="ciudad">Ciudad</label>
          <input id="ciudad" name="ciudad" type="text" />
        </div>
        <div class="field">
          <label for="giro">Giro</label>
          <input id="giro" name="giro" type="text" />
        </div>
        <div class="field field--span2">
          <label for="dir">Direcci√≥n</label>
          <input id="dir" name="dir" type="text" autocomplete="street-address" />
        </div>
      </div>
    </section>

    <!-- Actividades realizadas -->
    <section class="section">
      <h2 class="section__title">Actividades realizadas</h2>
      <div class="grid grid--2">
        <div>
          <label class="option"><input type="checkbox" name="act" value="Inspecci√≥n General en √Åreas de Proceso"> Inspecci√≥n General en √Åreas de Proceso</label>
          <label class="option"><input type="checkbox" name="act" value="Monitoreo y Control de Insectos Voladores"> Monitoreo y Control de Insectos Voladores</label>
          <label class="option"><input type="checkbox" name="act" value="Monitoreo y Control de Roedores"> Monitoreo y Control de Roedores</label>
          <label class="option"><input type="checkbox" name="act" value="Monitoreo y Control de Insectos Rastreros"> Monitoreo y Control de Insectos Rastreros</label>
        </div>
        <div>
          <label class="option"><input type="checkbox" name="act" value="Inspecci√≥n y Control de Aves Plaga"> Inspecci√≥n y Control de Aves Plaga</label>
          <label class="option"><input type="checkbox" name="act" value="Fumigaci√≥n General"> Fumigaci√≥n General</label>
          <label class="option"><input type="checkbox" name="act" value="Otros"> Otros</label>
        </div>
      </div>
    </section>

    <!-- Tipo de Tratamiento -->
    <section class="section" id="tipoTratamiento">
      <h2 class="section__title">Tipo de Tratamiento</h2>
      <div class="ttype" role="tablist" aria-label="Tipo de tratamiento">
        <label class="option"><input type="radio" name="tipo_trat" value="Preventivo" checked> Preventivo</label>
        <label class="option"><input type="radio" name="tipo_trat" value="Correctivo"> Correctivo</label>
      </div>
      <div class="grid grid--2" style="margin-top:8px;">
        <fieldset class="section">
          <legend>Opciones del Tratamiento</legend>
          <div class="grid grid--2">
            <div class="field">
              <label class="option"><input type="checkbox" name="trat" value="Insectos Rastreros"> Insectos Rastreros</label>
              <label class="option"><input type="checkbox" name="trat" value="Insectos Voladores"> Insectos Voladores</label>
              <label class="option"><input type="checkbox" name="trat" value="Roedores"> Roedores</label>
              <label class="option"><input type="checkbox" name="trat" value="Aves Plaga"> Aves Plaga</label>
              <label class="option"><input type="checkbox" name="plaga" value="Cucaracha Americana"> Cucaracha Americana</label>
              <label class="option"><input type="checkbox" name="plaga" value="Cucaracha Alemana"> Cucaracha Alemana</label>
            </div>
            <div class="field">
              <label class="option"><input type="checkbox" name="plaga" value="Moscas"> Moscas</label>
              <label class="option"><input type="checkbox" name="plaga" value="Hormiga"> Hormiga</label>
              <label class="option"><input type="checkbox" name="plaga" value="Rata"> Rata</label>
              <label class="option"><input type="checkbox" name="plaga" value="Rat√≥n"> Rat√≥n</label>
              <label class="option"><input type="checkbox" name="plaga" value="Alacr√°n"> Alacr√°n</label>
              <label class="option"><input type="checkbox" name="plaga" value="Otros"> Otros</label>
            </div>
          </div>
          <div class="inline" style="margin-top:8px;">
            <span>Invasor ocasional:</span>
            <input id="tt_invasor" type="text" name="invasor" placeholder="Especifique" style="margin-left:6px;flex:1;">
          </div>
        </fieldset>
        <fieldset class="section">
          <legend>Detalles</legend>
          <div class="field">
            <label for="localizacion">Localizaci√≥n</label>
            <input id="localizacion" name="localizacion" type="text" />
          </div>
          <div class="field" style="margin-top:6px;">
            <span>Grado de infestaci√≥n</span>
            <div class="inline">
              <label class="option"><input type="radio" name="infest" value="Alto"> Alto</label>
              <label class="option"><input type="radio" name="infest" value="Medio"> Medio</label>
              <label class="option"><input type="radio" name="infest" value="Bajo"> Bajo</label>
            </div>
          </div>
        </fieldset>
      </div>
    </section>

    <!-- Resumen y Dispositivos -->
    <section class="section">
      <h2 class="section__title">Resumen y Dispositivos</h2>
      <div class="grid grid--2">
        <fieldset class="section">
          <legend>Resumen</legend>
          <div class="inline">
            <span>Actividad de plagas:</span>
            <label class="option"><input type="radio" name="actividad_plagas" value="S√≠"> S√≠</label>
            <label class="option"><input type="radio" name="actividad_plagas" value="No"> No</label>
          </div>
          <div class="inline">
            <span>Riesgo de contaminaci√≥n por plagas:</span>
            <label class="option"><input type="radio" name="riesgo_contaminacion" value="S√≠"> S√≠</label>
            <label class="option"><input type="radio" name="riesgo_contaminacion" value="No"> No</label>
          </div>
        </fieldset>
        <fieldset class="section">
          <legend>Dispositivos</legend>
          <div class="grid grid--4">
            <div class="field"><label for="roedores_instalados">Roedores - Instalados</label><input type="number" id="roedores_instalados" name="roedores_instalados" min="0" step="1"></div>
            <div class="field"><label for="roedores_revisados">Roedores - Revisados</label><input type="number" id="roedores_revisados" name="roedores_revisados" min="0" step="1"></div>
            <div class="field"><label for="ulv_instaladas">L√°mparas ULV - Instaladas</label><input type="number" id="ulv_instaladas" name="ulv_instaladas" min="0" step="1"></div>
            <div class="field"><label for="ulv_revisadas">L√°mparas ULV - Revisadas</label><input type="number" id="ulv_revisadas" name="ulv_revisadas" min="0" step="1"></div>
          </div>
        </fieldset>
      </div>
    </section>

    <!-- Productos -->
    <section class="section">
      <h2 class="section__title">Productos, Dosis y M√©todos usados</h2>
      <div class="table">
        <div class="table__head">
          <div>Producto</div><div>Cantidad</div><div>Lts</div><div>M√©todo</div><div>Dosis</div><div>Lugar de aplicaci√≥n</div><div>Acciones</div>
        </div>
        <div class="table__body" id="itemsBody"></div>
        <div class="table__footer" style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#f3f6fb;border-top:1px solid var(--border);">
          <button id="addItem" class="btn" type="button">‚ûï Agregar fila</button>
          <span class="muted" style="font-size:.9rem;">Se imprimir√°n hasta 5 filas</span>
        </div>
      </div>
    </section>

    <!-- Acciones / Recomendaciones -->
    <section class="section">
      <div class="grid grid--2">
        <div class="field">
          <label for="acciones">Acciones Correctivas</label>
          <textarea id="acciones" name="acciones" rows="3"></textarea>
        </div>
        <div class="field">
          <label for="recomendaciones">Recomendaciones</label>
          <textarea id="recomendaciones" name="recomendaciones" rows="3"></textarea>
        </div>
      </div>
    </section>

    <!-- Mezcla / Informaci√≥n (Form) -->
    <section class="section">
      <div class="grid grid--2">
        <fieldset class="section">
          <legend>Mezcla</legend>
          <div class="grid grid--4">
            <div class="field"><label>Litros</label><input type="number" name="mez_litros" min="0" step="0.1"></div>
            <div class="field"><label>Metros</label><input type="number" name="mez_metros" min="0" step="1"></div>
            <div class="field"><label>Hora inicial</label><input type="time" name="mez_inicial"></div>
            <div class="field"><label>Hora final</label><input type="time" name="mez_final"></div>
          </div>
          <div class="field" style="margin-top:6px;">
            <label>Duraci√≥n (min)</label>
            <input type="number" name="mez_duracion" min="0" step="1">
          </div>
        </fieldset>
        <fieldset class="section">
          <legend>Informaci√≥n</legend>
          <!-- P√°rrafo fijo (no editable), con look de input -->
          <p class="info-fixed" id="info_fixed_form">
            Las condiciones de las instalaciones y las buenas pr√°cticas de manufactura permiten un control de plagas.
          </p>
          <!-- Textarea oculto para mantener el mapeo al PDF sin tocar funciones -->
          <textarea name="info_texto"
            placeholder="Las condiciones de las instalaciones y las buenas pr√°cticas de manufactura permiten un control de plagas."
            style="display:none" aria-hidden="true" tabindex="-1"></textarea>
          <div class="inline" style="margin-top:8px;">
            <span>Evaluaci√≥n:</span>
            <label class="option"><input type="radio" name="evaluacion" value="Excelente"> Excelente</label>
            <label class="option"><input type="radio" name="evaluacion" value="Bueno" checked> Bueno</label>
            <label class="option"><input type="radio" name="evaluacion" value="Regular"> Regular</label>
            <label class="option"><input type="radio" name="evaluacion" value="Malo"> Malo</label>
          </div>
        </fieldset>
      </div>
    </section>

    <!-- Firmas (captura) -->
    <section class="section">
      <div class="grid grid--2">
        <div class="signature">
          <h3>T√©cnico responsable</h3>
          <div class="field"><label>Nombre</label><input type="text" name="tecnico_nombre" placeholder="Nombre legible"></div>
          <div class="sig-pad"><canvas data-sig="tecnico" width="600" height="180" aria-label="Firma del t√©cnico"></canvas></div>
          <div class="signature__actions">
            <button class="btn" type="button" data-sig-clear="tecnico">üßΩ Limpiar</button>
            <button class="btn" type="button" data-sig-save="tecnico">üíæ Guardar firma</button>
          </div>
          <input type="hidden" name="firma_tecnico">
          <div class="grid grid--3" style="margin-top:8px;">
            <div class="field"><label for="km">Km</label><input type="number" id="km" name="km" min="0" step="1"></div>
            <div class="field"><label for="tt">TT</label><input type="text" id="tt" name="tt" placeholder="Tiempo/nota"></div>
            <div class="field"><label for="aux">Aux</label><input type="text" id="aux" name="aux" placeholder="Nombre del auxiliar"></div>
          </div>
        </div>
        <div class="signature">
          <h3>Cliente ‚Äî Conformidad del servicio</h3>
          <div class="field"><label>Nombre</label><input type="text" name="cliente_nombre" placeholder="Nombre legible"></div>
          <div class="sig-pad"><canvas data-sig="cliente" width="600" height="180" aria-label="Firma del cliente"></canvas></div>
          <div class="signature__actions">
            <button class="btn" type="button" data-sig-clear="cliente">üßΩ Limpiar</button>
            <button class="btn" type="button" data-sig-save="cliente">üíæ Guardar firma</button>
          </div>
          <input type="hidden" name="firma_cliente">
        </div>
      </div>
    </section>

    <!-- Valor / Garant√≠a / Servicios -->
    <section class="section">
      <div class="grid grid--3" style="margin-top:10px;">
        <div class="field"><label>Valor</label><input type="text" id="valor" name="valor" placeholder="Ej. 1500"></div>
        <div class="field"><label>Garant√≠a</label><input type="text" id="garantia" name="garantia"></div>
        <div class="field"><label>Servicios</label><input type="text" id="servicios" name="servicios"></div>
      </div>
    </section>

    <!-- Contacto -->
    <footer class="page__footer">
      <div class="muted"><strong>Contacto:</strong> 753 539 67 49 ¬∑ <strong>Email:</strong> entom@gmail.com</div>
      <button id="btnValidate" class="btn" type="submit">‚úÖ Validar</button>
    </footer>
  </form>

  <!-- ===== Hoja de IMPRESI√ìN ===== -->
  <section id="printSheet" aria-hidden="true">
    <div id="wm" aria-hidden="true"></div>
    <!-- Encabezado -->
    <div class="ps-header ps-box">
      <div>
        <div class="ps-title">Fumigaciones ENTOM</div>
        <div class="ps-sub">Constancia de Servicio</div>
      </div>
      <div>
        <div class="ps-small">Constancia No.</div>
        <div class="ps-cell" id="p_folio"></div>
      </div>
      <div>
        <div class="ps-small">Fecha</div>
        <div class="ps-cell" id="p_fecha"></div>
      </div>
    </div>

    <!-- Cliente ‚Äî 3 pares por fila -->
    <div class="ps-box">
      <div class="ps-vl-grid">
        <!-- Fila 1 -->
        <div class="ps-vl" style="grid-column: span 4;">
          <span class="lbl">Cliente</span>
          <span class="val" id="p_cliente">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 4;">
          <span class="lbl">N.I.C.</span>
          <span class="val" id="p_nic">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 4;">
          <span class="lbl">Tel√©fono</span>
          <span class="val" id="p_tel">‚Äî</span>
        </div>
        <!-- Fila 2 -->
        <div class="ps-vl" style="grid-column: span 4;">
          <span class="lbl">Ciudad</span>
          <span class="val" id="p_ciudad">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 4;">
          <span class="lbl">Giro</span>
          <span class="val" id="p_giro">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 4;">
          <span class="lbl">Direcci√≥n</span>
          <span class="val" id="p_dir">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Actividades / Tratamiento / Detalles -->
    <div class="ps-box">
      <div style="margin-bottom:1mm;">
        <div class="ps-small" style="margin-bottom:.6mm;">Actividades realizadas</div>
        <div id="p_acts" class="ps-small"></div>
      </div>
      <div style="margin-bottom:1mm;">
        <div class="ps-small" style="margin-bottom:.6mm;">Tratamiento</div>
        <div class="ps-cell" id="p_trat"></div>
      </div>
      <div class="ps-vl-grid">
        <div class="ps-vl" style="grid-column: span 4;">
          <span class="lbl">Grado de infestaci√≥n</span>
          <span class="val" id="p_infest">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 8;">
          <span class="lbl">Localizaci√≥n</span>
          <span class="val" id="p_local">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 6;">
          <span class="lbl">Actividad de plagas</span>
          <span class="val" id="p_actividad">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 6;">
          <span class="lbl">Riesgo de contaminaci√≥n</span>
          <span class="val" id="p_riesgo">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 6;">
          <span class="lbl">Roedores (Inst./Rev.)</span>
          <span class="val" id="p_roedores">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 6;">
          <span class="lbl">ULV (Inst./Rev.)</span>
          <span class="val" id="p_ulv">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Productos -->
    <div class="ps-box">
      <div class="ps-small" style="margin-bottom:1mm;">Productos, Dosis y M√©todos usados</div>
      <table class="ps-table" id="p_items">
        <thead>
          <tr>
            <th style="width:36%;">Producto</th>
            <th style="width:8%;">Cant.</th>
            <th style="width:8%;">Lts</th>
            <th style="width:14%;">M√©todo</th>
            <th style="width:14%;">Dosis</th>
            <th style="width:20%;">Lugar</th>
          </tr>
        </thead>
        <tbody id="p_items_body"></tbody>
      </table>
      <div id="p_items_note" class="ps-small" style="margin-top:1.2mm; color:#444;"></div>
      <div class="ps-small" style="margin-top:1.2mm;">
        <strong>M√©todos de aplicaci√≥n (abreviaturas):</strong>
        A (Aspersi√≥n manual) ¬∑ AM (Aspersi√≥n motorizada) ¬∑ I (Inyecci√≥n) ¬∑
        N (Nebulizaci√≥n) ¬∑ T (Termonebulizaci√≥n) ¬∑ AM (Aplicaci√≥n manual) ¬∑
        E (Espuma) ¬∑ ES (Espolvoreo)
      </div>
    </div>

    <!-- Mezcla e Informaci√≥n -->
    <div class="ps-box">
      <div class="ps-mi-grid">
        <div><div class="ps-mi-head">Litros</div><div class="ps-uline" id="p_mez_litros">‚Äî</div></div>
        <div><div class="ps-mi-head">Metros</div><div class="ps-uline" id="p_mez_metros">‚Äî</div></div>
        <div><div class="ps-mi-head">Hora inicial</div><div class="ps-uline" id="p_mez_inicial">‚Äî</div></div>
        <div><div class="ps-mi-head">Hora final</div><div class="ps-uline" id="p_mez_final">‚Äî</div></div>
        <div><div class="ps-mi-head">Duraci√≥n (min)</div><div class="ps-uline" id="p_mez_duracion">‚Äî</div></div>
        <div><div class="ps-mi-head">Evaluaci√≥n</div><div class="ps-uline" id="p_eval">‚Äî</div></div>
      </div>
      <div class="ps-info-row" style="margin-top:1.6mm;">
        <div class="ps-info-title">Informaci√≥n:</div>
        <div class="ps-info-text" id="p_info">
          Las condiciones de las instalaciones y las buenas pr√°cticas de manufactura permiten un control de plagas.
        </div>
      </div>
      <div class="ps-metrics-wrap">
        <div class="ps-metrics-title">M√©tricas de visita</div>
        <div class="ps-metrics">
          <div class="ps-mchip">
            <span class="ps-mchip__label">KM</span>
            <span class="ps-mchip__val" id="p_km_big">‚Äî</span>
          </div>
          <div class="ps-mchip">
            <span class="ps-mchip__label">TT</span>
            <span class="ps-mchip__val" id="p_tt_big">‚Äî</span>
          </div>
          <div class="ps-mchip">
            <span class="ps-mchip__label">Aux</span>
            <span class="ps-mchip__val" id="p_aux_big">‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <!-- FIRMAS EN PDF -->
    <div class="ps-signs">
      <div>
        <div class="ps-small" style="margin-bottom:1.2mm;">Firma T√©cnico Responsable</div>
        <div class="ps-sign"><img id="p_firma_tecnico" alt=""></div>
        <div class="ps-signname" id="p_tecnico_nombre">‚Äî</div>
      </div>
      <div>
        <div class="ps-small" style="margin-bottom:1.2mm;">Firma Cliente (Conformidad)</div>
        <div class="ps-sign"><img id="p_firma_cliente" alt=""></div>
        <div class="ps-signname" id="p_cliente_nombre">‚Äî</div>
      </div>
    </div>

    <!-- Tres notas fijas -->
    <div class="ps-box">
      <div class="ps-small" style="margin-bottom:1.2mm;">Medidas de precauci√≥n</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:2mm;">
        <div style="border:1px solid #444; background:#fff; padding:1.2mm 1.4mm;">
          <div style="font-weight:800; font-size:9.3pt; margin:0 0 1mm 0;">Medidas de precauci√≥n</div>
          <p style="margin:0; font-size:9pt; line-height:1.15; color:#111;">
            Previo a la aplicaci√≥n deber√°n guardarse los alimentos sobrantes y que no ser√°n utilizados pronto,
            proteger superficies y utensilios que no ser√°n utilizados, retirar y proteger medicamentos y
            avisar sobre padecimientos al√©rgicos.
          </p>
        </div>
        <div style="border:1px solid #444; background:#fff; padding:1.2mm 1.4mm;">
          <div style="font-weight:800; font-size:9.3pt; margin:0 0 1mm 0;">Durante la Ejecuci√≥n</div>
          <p style="margin:0; font-size:9pt; line-height:1.15; color:#111;">
            Evitar estar en la zona de aplicaci√≥n sin equipo de protecci√≥n personal. No manipular los productos
            ni permitir el ingreso en presencia de personas y animales dom√©sticos. Evitar el contacto con ojos y piel.
          </p>
        </div>
        <div style="border:1px solid #444; background:#fff; padding:1.2mm 1.4mm;">
          <div style="font-weight:800; font-size:9.3pt; margin:0 0 1mm 0;">Posterior a la Aplicaci√≥n</div>
          <p style="margin:0; font-size:9pt; line-height:1.15; color:#111;">
            Se debe esperar un m√≠nimo de 60 minutos para el reingreso a las √°reas tratadas. Seguir las instrucciones
            y recomendaciones del t√©cnico aplicador.
          </p>
        </div>
      </div>
    </div>

    <!-- Valor / Garant√≠a / Servicios (abajo, antes de Contacto) -->
    <div class="ps-box">
      <div class="ps-vl-grid">
        <div class="ps-vl" style="grid-column: span 4;">
          <span class="lbl">Valor</span>
          <span class="val" id="p_valor">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 4;">
          <span class="lbl">Garant√≠a</span>
          <span class="val" id="p_garantia">‚Äî</span>
        </div>
        <div class="ps-vl" style="grid-column: span 4;">
          <span class="lbl">Servicios</span>
          <span class="val" id="p_servicios">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Contacto -->
    <div class="ps-box ps-contact">Contacto: 753 539 67 49 ¬∑ Email: entom@gmail.com</div>
  </section>
</main>

<script>
/* ==== Helpers ==== */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
/* ==== Tema ==== */
$('#btnTheme')?.addEventListener('click', ()=>{ 
 const dark = document.documentElement.classList.toggle('dark'); 
 $('#btnTheme').textContent = dark ? 'üåô Tema' : 'üåû Tema'; 
});
/* ==== M√©todos (select) ==== */
const METHOD_OPTIONS = [
 {value:'A', text:'A ‚Äî Aspersi√≥n manual'},
 {value:'AM', text:'AM ‚Äî Aspersi√≥n motorizada'},
 {value:'I', text:'I ‚Äî Inyecci√≥n'},
 {value:'N', text:'N ‚Äî Nebulizaci√≥n'},
 {value:'T', text:'T ‚Äî Termonebulizaci√≥n'},
 {value:'AM', text:'AM ‚Äî Aplicaci√≥n manual'},
 {value:'E', text:'E ‚Äî Espuma'},
 {value:'ES', text:'ES ‚Äî Espolvoreo'}
];
function methodSelectHTML(selected=''){
 const opts = METHOD_OPTIONS.map(o=>{
 const sel = (o.value===selected) ? ' selected' : '';
 return `<option value="${o.value}"${sel}>${o.text}</option>`;
 }).join('');
 return `<select name="item_metodo" title="Selecciona el m√©todo de aplicaci√≥n">${opts}</select>`;
}
/* ==== Tabla din√°mica (captura) ==== */
const itemsBody = $('#itemsBody');
$('#addItem')?.addEventListener('click', ()=> addRow());
function addRow(prod='', cant=1, lts=0, metodo='', dosis='', lugar=''){
 const row = document.createElement('div');
 row.className = 'table__row'; row.setAttribute('data-row','');
 row.innerHTML = `
 <input type="text" name="item_prod" placeholder="Producto" value="${prod}">
 <input type="number" name="item_cant" min="0" step="1" value="${cant}">
 <input type="number" name="item_lts" min="0" step="0.1" value="${lts}">
 ${methodSelectHTML(metodo)}
 <input type="text" name="item_dosis" placeholder="Dosis" value="${dosis}">
 <input type="text" name="item_lugar" placeholder="Lugar" value="${lugar}">
 <div style="display:flex; gap:6px;">
 <button type="button" class="btn" data-act="dup" title="Duplicar">‚éò</button>
 <button type="button" class="btn btn--danger" data-act="del" title="Eliminar">üóëÔ∏è</button>
 </div>`;
 itemsBody.appendChild(row);
 row.addEventListener('click', (e)=>{
 const btn = e.target.closest('button[data-act]'); if (!btn) return;
 const act = btn.getAttribute('data-act');
 if (act==='del'){ row.remove(); autoSave(); }
 if (act==='dup'){
 addRow(
 $('input[name="item_prod"]', row).value,
 Number($('input[name="item_cant"]', row).value)||0,
 Number($('input[name="item_lts"]', row).value)||0,
 $('select[name="item_metodo"]',row).value,
 $('input[name="item_dosis"]', row).value,
 $('input[name="item_lugar"]', row).value
 );
 }
 });
 autoSave();
}
/* ==== Autoguardado ==== */
const STORAGE_KEY = 'entom_constancia_final_plus';
const form = $('#formDoc');
function getData(){
 const fd = new FormData(form); const data = {};
 for (const [k,v] of fd.entries()){
 if (data[k]) Array.isArray(data[k]) ? data[k].push(v) : data[k] = [data[k], v];
 else data[k] = v;
 }
 data.items = $$('[data-row]').map(r => ({
 prod : $('input[name="item_prod"]', r)?.value?.trim() ?? '',
 cant : $('input[name="item_cant"]', r)?.value?.trim() ?? '',
 lts : $('input[name="item_lts"]', r)?.value?.trim() ?? '',
 metodo:$('select[name="item_metodo"]',r)?.value?.trim() ?? '',
 dosis: $('input[name="item_dosis"]', r)?.value?.trim() ?? '',
 lugar: $('input[name="item_lugar"]', r)?.value?.trim() ?? '',
 }));
 return data;
}
function setData(data){
 if (!data) return;
 Object.entries(data).forEach(([k,v])=>{
 if (k==='items') return;
 const els = $$(`[name="${CSS.escape(k)}"]`);
 if (!els.length) return;
 if (els[0].type==='checkbox' || els[0].type==='radio'){
 els.forEach(el => el.checked = Array.isArray(v) ? v.includes(el.value) : (v===el.value || v==='on'));
 } else { els[0].value = v; }
 });
 itemsBody.innerHTML = '';
 if (Array.isArray(data.items) && data.items.length){
 data.items.forEach(it => addRow(it.prod, it.cant, it.lts, it.metodo, it.dosis, it.lugar));
 } else addRow();
}
function autoSave(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(getData())); }
form?.addEventListener('input', autoSave);
/* ==== Validaci√≥n ==== */
function validate(){
 const errs = [];
 ['fecha','tecnico','cliente'].forEach(id => {
 const el = document.getElementById(id);
 if (!el || !el.value.trim()) errs.push(`‚Ä¢ ${id} es obligatorio`);
 });
 const nic = $('#nic')?.value ?? '';
 const folio = $('#folio')?.value ?? '';
 if (nic && nic.length > 15) errs.push('‚Ä¢ N.I.C. debe tener como m√°ximo 15 caracteres.');
 if (folio && folio.length > 15) errs.push('‚Ä¢ Constancia de Servicio No. (folio) debe tener como m√°ximo 15 caracteres.');
 const tel = $('#tel');
 if (tel && tel.value){
 const d = tel.value.replace(/\D/g,'');
 if (d.length !== 10) errs.push('‚Ä¢ El tel√©fono debe tener 10 d√≠gitos (Mx).');
 }
 if (!$$('input[name="act"]:checked').length) errs.push('‚Ä¢ Marca al menos una Actividad realizada.');
 const f1 = $('input[name="firma_tecnico"]').value;
 const f2 = $('input[name="firma_cliente"]').value;
 if (!f1) errs.push('‚Ä¢ Falta la firma del T√âCNICO (firma autom√°tica al soltar).');
 if (!f2) errs.push('‚Ä¢ Falta la firma del CLIENTE (firma autom√°tica al soltar).');
 if (errs.length){ alert('Corrige:\n' + errs.join('\n')); return false; }
 return true;
}
$('#btnValidate')?.addEventListener('click', (e)=>{ e.preventDefault(); if (validate()) alert('Validado ‚úÖ.'); });
/* ==== Utilidades PDF ==== */
function textOrDash(v){ return (v??'').toString().trim() || '‚Äî'; }
function fmtMoney(mx){
 const s = (mx??'').toString().trim();
 if(!s) return '‚Äî';
 const num = Number(s.replace(/[^\d.\-]/g,''));
 if(isNaN(num)) return `$ ${s}`;
 return `$ ${num.toLocaleString('es-MX')}`;
}
/* ==== Preparar PDF ==== */
function safePopulatePrintSheet(){
 const txt = v => (v??'').toString().trim() || '‚Äî';
 const getVal = id => { const el = $(id); return el ? txt(el.value) : '‚Äî'; };
 const getChk = name => $$(`input[name="${name}"]:checked`).map(x=>x.value);
 if (!$('#printSheet')) return;
 // Encabezado
 $('#p_folio') && ($('#p_folio').textContent = getVal('#folio'));
 $('#p_fecha') && ($('#p_fecha').textContent = getVal('#fecha'));
 // Cliente
 $('#p_cliente') && ($('#p_cliente').textContent = getVal('#cliente'));
 $('#p_nic') && ($('#p_nic').textContent = getVal('#nic'));
 $('#p_tel') && ($('#p_tel').textContent = getVal('#tel'));
 $('#p_ciudad') && ($('#p_ciudad').textContent = getVal('#ciudad'));
 $('#p_giro') && ($('#p_giro').textContent = getVal('#giro'));
 $('#p_dir') && ($('#p_dir').textContent = getVal('#dir'));
 // Actividades
 const acts = getChk('act');
 $('#p_acts') && ($('#p_acts').innerHTML = acts.map(a=>`<span class="ps-tag ps-tag--on">${a}</span>`).join(' '));
 // Tratamiento
 const tipo = (document.querySelector('input[name="tipo_trat"]:checked')?.value)||'';
 const trats = getChk('trat').map(t=>`<span class="ps-tag ps-tag--on">${t}</span>`).join(' ');
 const plags = getChk('plaga').map(p=>`<span class="ps-tag ps-tag--on">${p}</span>`).join(' ');
 const invasor = (document.querySelector('[name="invasor"]')?.value ?? '').trim();
 const mixHTML = [ (tipo?`<span class="ps-tag ps-tag--on">${tipo}</span>`:''), trats, plags, (invasor?`<span class="ps-tag">${invasor}</span>`:'') ]
 .filter(Boolean).join(' ¬∑ ') || '‚Äî';
 $('#p_trat') && ($('#p_trat').innerHTML = mixHTML);
 // Resumen / detalles
 const infest = (document.querySelector('input[name="infest"]:checked')?.value)||'';
 $('#p_infest') && ($('#p_infest').textContent = txt(infest));
 $('#p_local') && ($('#p_local').textContent = getVal('#localizacion'));
 const actTxt = (document.querySelector('input[name="actividad_plagas"]:checked')?.value)||'';
 const rieTxt = (document.querySelector('input[name="riesgo_contaminacion"]:checked')?.value)||'';
 $('#p_actividad') && ($('#p_actividad').textContent = txt(actTxt));
 $('#p_riesgo') && ($('#p_riesgo').textContent = txt(rieTxt));
 const rI = getVal('#roedores_instalados'); const rR = getVal('#roedores_revisados');
 const uI = getVal('#ulv_instaladas'); const uR = getVal('#ulv_revisadas');
 $('#p_roedores') && ($('#p_roedores').textContent = (rI!=='‚Äî' && rR!=='‚Äî') ? `${rI==='‚Äî'?0:rI} / ${rR==='‚Äî'?0:rR}` : '‚Äî');
 $('#p_ulv') && ($('#p_ulv').textContent = (uI!=='‚Äî' && uR!=='‚Äî') ? `${uI==='‚Äî'?0:uI} / ${uR==='‚Äî'?0:uR}` : '‚Äî');
 // Mezcla e Informaci√≥n
 $('#p_mez_litros') && ($('#p_mez_litros').textContent = txt(document.querySelector('[name="mez_litros"]')?.value ?? ''));
 $('#p_mez_metros') && ($('#p_mez_metros').textContent = txt(document.querySelector('[name="mez_metros"]')?.value ?? ''));
 $('#p_mez_inicial') && ($('#p_mez_inicial').textContent = txt(document.querySelector('[name="mez_inicial"]')?.value ?? ''));
 $('#p_mez_final') && ($('#p_mez_final').textContent = txt(document.querySelector('[name="mez_final"]')?.value ?? ''));
 $('#p_mez_duracion') && ($('#p_mez_duracion').textContent = txt(document.querySelector('[name="mez_duracion"]')?.value ?? ''));
 
const info_texto = document.getElementById('info_fixed_form')?.textContent.trim() || '‚Äî';
$('#p_info').textContent = info_texto;

 const evalEl = document.querySelector('input[name="evaluacion"]:checked');
 $('#p_eval') && ($('#p_eval').textContent = txt(evalEl ? evalEl.value : ''));
 // Productos
 try{
 const rows = Array.from(document.querySelectorAll('[data-row]')).slice(0,5).map(r => ({
  prod : (r.querySelector('input[name="item_prod"]') ?.value ?? '').toString().slice(0,40),
  cant : (r.querySelector('input[name="item_cant"]') ?.value ?? '').toString().slice(0,6),
  lts  : (r.querySelector('input[name="item_lts"]')  ?.value ?? '').toString().slice(0,6),
  metodo: (r.querySelector('select[name="item_metodo"]')?.value ?? '').toString().slice(0,16),
  dosis : (r.querySelector('input[name="item_dosis"]') ?.value ?? '').toString().slice(0,16),
  lugar : (r.querySelector('input[name="item_lugar"]') ?.value ?? '').toString().slice(0,22),
 }));
 const tbody = $('#p_items_body');
 if (tbody){
  tbody.innerHTML = '';
  rows.forEach(it=>{
   const tr = document.createElement('tr');
   tr.innerHTML = `
   <td>${it.prod}</td>
   <td style="text-align:center;">${it.cant}</td>
   <td style="text-align:center;">${it.lts}</td>
   <td>${it.metodo}</td>
   <td>${it.dosis}</td>
   <td>${it.lugar}</td>`;
   tbody.appendChild(tr);
  });
  const totalFormRows = document.querySelectorAll('[data-row]').length;
  const note = $('#p_items_note');
  if (note) note.textContent = totalFormRows > 5 ? `* Se muestran 5 de ${totalFormRows} filas.` : '';
 }
 }catch(e){ console.warn('Se omiti√≥ tabla de productos por error:', e); }
 // Valor / Garant√≠a / Servicios
 $('#p_valor') && ($('#p_valor').textContent = fmtMoney(getVal('#valor')));
 $('#p_garantia') && ($('#p_garantia').textContent = getVal('#garantia'));
 $('#p_servicios') && ($('#p_servicios').textContent = getVal('#servicios'));
 // Firmas + nombres (PDF)
 const fTec = $('input[name="firma_tecnico"]')?.value ?? '';
 const fCli = $('input[name="firma_cliente"]')?.value ?? '';
 $('#p_firma_tecnico') && ($('#p_firma_tecnico').src = fTec);
 $('#p_firma_cliente') && ($('#p_firma_cliente').src = fCli);
 $('#p_tecnico_nombre') && ($('#p_tecnico_nombre').textContent = txt($('input[name="tecnico_nombre"]')?.value));
 $('#p_cliente_nombre') && ($('#p_cliente_nombre').textContent = txt($('input[name="cliente_nombre"]')?.value));
 // M√©tricas
 $('#p_km_big') && ($('#p_km_big').textContent = txt($('#km')?.value));
 $('#p_tt_big') && ($('#p_tt_big').textContent = txt($('#tt')?.value));
 $('#p_aux_big') && ($('#p_aux_big').textContent = txt($('#aux')?.value));
}
/* ==== Imprimir ==== */
$('#btnPrint')?.addEventListener('click', async ()=>{
 try{
 const ok = validate();
 if (!ok){
 const seguir = confirm('Hay campos obligatorios sin completar.\n¬øQuieres imprimir de todos modos?');
 if (!seguir) return;
 }
 } catch(e) {
 console.warn('validate() fall√≥, continuo a imprimir:', e);
 }
 try { safePopulatePrintSheet(); } catch (e) { console.error('Error al preparar datos de impresi√≥n:', e); }
 try { await new Promise(r => requestAnimationFrame(()=>requestAnimationFrame(r))); } catch(e){}
 window.print();
});
/* ==== Limpiar ==== */
$('#btnClear')?.addEventListener('click', ()=>{
 if (!confirm('¬øSeguro que deseas limpiar el formulario y borrar el autoguardado?')) return;
 localStorage.removeItem(STORAGE_KEY);
 form.reset();
 itemsBody.innerHTML=''; addRow(); clearAllSignatures();
});
/* ==== Firma digital ==== */
const sigPads = {};
document.querySelectorAll('canvas[data-sig]').forEach((canvas)=>{
 const key = canvas.getAttribute('data-sig');
 const ctx = canvas.getContext('2d');
 ctx.lineWidth=2; ctx.lineJoin='round'; ctx.lineCap='round';
 try { ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#000'; }
 catch { ctx.strokeStyle = '#000'; }
 let drawing=false;
 const getPos = (e)=>{
 const rect=canvas.getBoundingClientRect(); const ev=e.touches?e.touches[0]:e;
 const x=(ev.clientX-rect.left)*(canvas.width/rect.width);
 const y=(ev.clientY-rect.top)*(canvas.height/rect.height);
 return {x,y};
 };
 const start=(e)=>{ drawing=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); };
 const move =(e)=>{ if(!drawing) return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); };
 const end =()=>{ 
 drawing=false; 
 const hidden = document.querySelector(`input[name="firma_${key}"]`);
 if (hidden) { 
 try { hidden.value = canvas.toDataURL('image/png'); if (typeof autoSave==='function') autoSave(); } catch(e){}
 }
 };
 canvas.addEventListener('mousedown', start);
 canvas.addEventListener('mousemove', move);
 window.addEventListener('mouseup', end);
 canvas.addEventListener('touchstart', e=>{ e.preventDefault(); start(e); }, {passive:false});
 canvas.addEventListener('touchmove', e=>{ e.preventDefault(); move(e); }, {passive:false});
 canvas.addEventListener('touchend', e=>{ e.preventDefault(); end(); }, {passive:false});
 sigPads[key] = { canvas, ctx };
});
function saveSignature(key){
 const pad = sigPads[key]; if (!pad) return;
 try{
 const dataUrl = pad.canvas.toDataURL('image/png');
 const hidden = document.querySelector(`input[name="firma_${key}"]`);
 if (hidden) hidden.value = dataUrl;
 if (typeof autoSave==='function') autoSave();
 alert(`Firma de ${key} guardada.`);
 }catch(err){
 console.error('Error al guardar la firma:', err);
 alert('No se pudo guardar la firma. Revisa la consola (F12).');
 }
}
function clearSignature(key){
 const pad = sigPads[key]; if (!pad) return;
 pad.ctx.clearRect(0,0,pad.canvas.width,pad.canvas.height);
 const hidden = document.querySelector(`input[name="firma_${key}"]`);
 if (hidden) hidden.value = '';
 if (typeof autoSave==='function') autoSave();
}
function clearAllSignatures(){ Object.keys(sigPads).forEach(clearSignature); }
/* === [FIX] Delegaci√≥n de eventos para Guardar/Limpiar firma (√∫nico ajuste) === */
document.addEventListener('click', (e) => {
 const btn = e.target.closest('[data-sig-save],[data-sig-clear]');
 if (!btn) return;
 const saveKey = btn.getAttribute('data-sig-save');
 const clearKey = btn.getAttribute('data-sig-clear');
 if (saveKey){ e.preventDefault(); saveSignature(saveKey); }
 else if (clearKey){ e.preventDefault(); clearSignature(clearKey); }
});
/* ==== Tel√©fono ==== */
const tel = document.getElementById('tel');
if (tel){
 tel.addEventListener('input', ()=>{ const digits = tel.value.replace(/\D/g,'').slice(0,10); tel.value = digits; });
 tel.addEventListener('blur', ()=>{ const d = tel.value.replace(/\D/g,''); if (d.length===10) tel.value = `(${d.slice(0,2)}) ${d.slice(2,6)} ${d.slice(6)}`; });
}
/* ==== Inicial ==== */
const fecha = document.getElementById('fecha'); if (fecha && !fecha.value) fecha.valueAsDate = new Date();
const saved = localStorage.getItem(STORAGE_KEY);
if (saved){ try{ setData(JSON.parse(saved)); } catch(e){ addRow(); } }
if (!itemsBody.children.length) addRow();
</script>


<script>
/* ============================================================
   CONVERSI√ìN DIN√ÅMICA DE FILAS ‚Üí TARJETAS SOLO EN M√ìVIL
   ============================================================ */

(function() {

  const LABELS = {
    item_prod:  'Producto',
    item_cant:  'Cantidad',
    item_lts:   'Lts',
    item_metodo:'M√©todo',
    item_dosis: 'Dosis',
    item_lugar: 'Lugar'
  };

  const isMobile = () => window.matchMedia('(max-width: 820px)').matches;

  /* Aplica modo tarjeta a una fila */
  function convertRowToCard(row) {
    if (!row || row.dataset.cardMode === "1") return;

    const fields = [
      row.querySelector('input[name="item_prod"]'),
      row.querySelector('input[name="item_cant"]'),
      row.querySelector('input[name="item_lts"]'),
      row.querySelector('select[name="item_metodo"]'),
      row.querySelector('input[name="item_dosis"]'),
      row.querySelector('input[name="item_lugar"]')
    ].filter(Boolean);

    const actions = row.querySelector('button[data-act]')?.parentElement;

    /* Insertar etiquetas */
    fields.forEach(el => {
      if (!el) return;
      const name = el.getAttribute("name");
      if (!name || !LABELS[name]) return;

      const label = document.createElement("div");
      label.className = "mpr-label";
      label.textContent = LABELS[name];

      row.insertBefore(label, el);
    });

    /* Convertir Cant/Lts a texto libre */
    const cant = row.querySelector('input[name="item_cant"]');
    const lts  = row.querySelector('input[name="item_lts"]');

    if (cant) {
      cant.type = "text";
      cant.placeholder = "Cantidad (ej. 2 pzas)";
      cant.inputMode = "decimal";
    }
    if (lts) {
      lts.type = "text";
      lts.placeholder = "Lts (ej. 0.5 lt)";
      lts.inputMode = "decimal";
    }

    /* Etiqueta para acciones */
    if (actions) {
      const lab = document.createElement("div");
      lab.className = "mpr-label";
      lab.textContent = "Acciones";
      row.insertBefore(lab, actions);
      actions.classList.add("mpr__actions");
    }

    row.dataset.cardMode = "1";
  }

  /* Revertir a modo tabla en escritorio */
  function revertRowFromCard(row) {
    if (!row || row.dataset.cardMode !== "1") return;

    /* Eliminar etiquetas */
    row.querySelectorAll('.mpr-label').forEach(el => el.remove());

    /* Restaurar tipos num√©ricos */
    const cant = row.querySelector('input[name="item_cant"]');
    const lts  = row.querySelector('input[name="item_lts"]');

    if (cant) {
      cant.type = "number";
      cant.min = "0";
      cant.step = "1";
      cant.removeAttribute("inputmode");
    }
    if (lts) {
      lts.type = "number";
      lts.min = "0";
      lts.step = "0.1";
      lts.removeAttribute("inputmode");
    }

    const actions = row.querySelector('button[data-act]')?.parentElement;
    if (actions) actions.classList.remove('mpr__actions');

    delete row.dataset.cardMode;
  }

  /* Aplica a todas las filas existentes */
  function updateAllRows() {
    document.querySelectorAll('[data-row]').forEach(row => {
      if (isMobile()) convertRowToCard(row);
      else revertRowFromCard(row);
    });
  }

  /* Al cargar */
  document.addEventListener("DOMContentLoaded", () => {
    setTimeout(updateAllRows, 50);
  });

  /* Al cambiar tama√±o */
  window.addEventListener("resize", () => {
    setTimeout(updateAllRows, 50);
  });

  /* Parchea addRow para que nuevas filas salgan como tarjetas en m√≥vil */
  const oldAddRow = window.addRow;
  window.addRow = function(...args) {
    oldAddRow.apply(this, args);
    const rows = document.querySelectorAll('[data-row]');
    const last = rows[rows.length - 1];
    if (isMobile()) convertRowToCard(last);
  };

})();
</script>


</body>
</html>
